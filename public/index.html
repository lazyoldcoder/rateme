
<!DOCTYPE html>
<!-- retrieved from feb10814 at 0823 after a disaster bulk chasge-->
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="styles.css">
<title>Rate Me</title>
<style>

</style>
</head>
<body>

<h1>ğŸ˜¡RateMeğŸ˜„</h1>

<!-- Business Cards -->
<div id="businessContainer"></div>

<!-- Rating Form -->
<div id="loginContainer">
  <input type="text" id="usernameInput" placeholder="Username">
  <button id="reRegisterBtn">Register</button>
  <button id="loginBtn">Login</button>
  
</div>

<form id="ratingForm">

  <label>Rating</label>

    <div id="starRating" class="emoji-rating">
        <button type="button" class="emoji-btn" data-value="1" aria-label="Very bad">ğŸ˜¡</button>
        <button type="button" class="emoji-btn" data-value="2" aria-label="Bad">ğŸ˜</button>
        <button type="button" class="emoji-btn" data-value="3" aria-label="Neutral">ğŸ˜</button>
        <button type="button" class="emoji-btn" data-value="4" aria-label="Good">ğŸ™‚</button>
        <button type="button" class="emoji-btn" data-value="5" aria-label="Excellent">ğŸ˜„</button>
    </div>

        
    <!-- Star display (driven by emoji selection) -->
    <div id="starDisplay">
      <span class="star" data-value="1">â˜…</span>
      <span class="star" data-value="2">â˜…</span>
      <span class="star" data-value="3">â˜…</span>
      <span class="star" data-value="4">â˜…</span>
      <span class="star" data-value="5">â˜…</span>
    </div>
     
  <label for="comment">Comment</label>
  <textarea id="comment" rows="3"></textarea>

  <button type="submit">Submit</button>
</form>

<!-- All Ratings List -->
<div id="ratingsContainer">
  <h2>All Ratings</h2>
  <div id="ratingsList"></div>
</div>


<script>
  /* ======= Data-driven businesses ======= */
const businesses = [
  { id: 'johns-coffee', name: 'Johns Coffee', img: 'images/johns-coffee.jpg' },
  { id: 'jills-hair', name: 'Jills Hair', img: 'images/jills-hair.jpg' },
  { id: 'jack-plumber', name: 'Jack Plumber', img: 'images/jack-plumber.jpg' }
];

/* ======= DOM references ======= */
const businessContainer = document.getElementById('businessContainer');
const ratingsList = document.getElementById('ratingsList');
const form = document.getElementById('ratingForm');
const commentInput = document.getElementById('comment');
const emojiBtns = document.querySelectorAll('.emoji-btn');
const stars = document.querySelectorAll('.star');

let currentBusiness = localStorage.getItem('lastBusiness') || businesses[0].id;
let selectedRating = 0;
let lastSubmittedRating = null; // Track the last submitted rating for highlight

/* ======= Render business cards ======= */
const cardsWrapper = document.createElement('div');
cardsWrapper.className = 'cards-wrapper';
businessContainer.appendChild(cardsWrapper);

function renderBusinessCards() {
  cardsWrapper.innerHTML = '';
  businesses.forEach(b => {
    const card = document.createElement('div');
    card.className = 'business-card';
    card.dataset.id = b.id;

    const name = document.createElement('div');
    name.className = 'name';
    name.textContent = b.name;
    card.appendChild(name);

    card.addEventListener('click', () => selectBusiness(b.id));
    cardsWrapper.appendChild(card);
  });
}

/* ======= Select business ======= */
function selectBusiness(id) {
  currentBusiness = id;
  localStorage.setItem('lastBusiness', id);

  document.querySelectorAll('.business-card').forEach(card => {
    card.classList.toggle('selected', card.dataset.id === id);
  });

  fetchRatings();
}

/* ======= Emoji â†’ Star Rating ======= */
emojiBtns.forEach(btn => {
  btn.addEventListener('click', e => {
    e.preventDefault();

    selectedRating = parseInt(btn.dataset.value);

    // Highlight emoji
    emojiBtns.forEach(b =>
      b.classList.toggle('selected', b.dataset.value == selectedRating)
    );

    // Drive star display
    stars.forEach(s =>
      s.classList.toggle('selected', s.dataset.value <= selectedRating)
    );
  });
});



/* ======= Fetch Ratings ======= */
async function fetchRatings() {
  try {
    const res = await fetch('/api/ratings');
    const ratings = await res.json();

    // Filter current business and sort newest first
    const filtered = ratings
      .filter(r => r.business === currentBusiness)
      .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

    ratingsList.innerHTML = '';

    if (!filtered.length) {
      ratingsList.innerHTML = '<p>No ratings yet for this business.</p>';
      return;
    }


    for (const r of filtered) {
      const div = document.createElement('div');
      div.className = 'rating-card';

      // Highlight newly submitted rating
      if (lastSubmittedRating && r.id === lastSubmittedRating.id) {
        div.classList.add('new-rating');
        div.offsetHeight; // force reflow
        setTimeout(() => div.classList.remove('new-rating'), 10000);
        div.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      // Get latest user info from KV
      let userData = { email: 'no email', phone: 'no phone' };
      try {
        const resp = await fetch(`/api/users?username=${encodeURIComponent(r.username)}`);
        const data = await resp.json();
        if (data.email) userData.email = data.email;
        if (data.phone) userData.phone = data.phone;
      } catch (err) {
        console.warn("Failed to fetch user data for rating:", r.username);
      }

      const starsDisplay = 'â˜…'.repeat(r.rating) + 'â˜†'.repeat(5 - r.rating);

      div.innerHTML = `
        <div class="stars-display">${starsDisplay}</div>
        <div>
          <strong>${r.username}</strong>
          (${userData.email}, ${userData.phone})
        </div>
        <div>${r.comment || '<em>No comment</em>'}</div>
        <div class="timestamp">${new Date(r.timestamp).toLocaleString()}</div>
      `;

      ratingsList.appendChild(div);
    }

    // Reset highlight flag
    lastSubmittedRating = null;



    // filtered.forEach((r, index) => {
    //   const div = document.createElement('div');
    //   div.className = 'rating-card';

    //   // Highlight the newly submitted rating
    //   if (lastSubmittedRating && index === 0) {
    //     div.classList.add('new-rating');
    //     div.offsetHeight; // force reflow for smooth animation
    //     setTimeout(() => div.classList.remove('new-rating'), 10000);
    //     div.scrollIntoView({ behavior: 'smooth', block: 'start' });
    //   }

    //   // Display stars
    //   const starsDisplay = 'â˜…'.repeat(r.rating) + 'â˜†'.repeat(5 - r.rating);

    //   // Include user info for business visibility
    //   div.innerHTML = `
    //     <div class="stars-display">${starsDisplay}</div>
    //     <div>
    //       <strong>${r.username || 'Anonymous'}</strong>
    //       (${r.email || 'no email'}, ${r.phone || 'no phone'})
    //     </div>
    //     <div>${r.comment || '<em>No comment</em>'}</div>
    //     <div class="timestamp">${new Date(r.timestamp).toLocaleString()}</div>
    //   `;

    //   ratingsList.appendChild(div);
    // });








    // filtered.forEach((r, index) => {
    //   const div = document.createElement('div');
    //   div.className = 'rating-card';

    //   // Only highlight the first item if lastSubmittedRating exists
    //   if (lastSubmittedRating && index === 0) {
    //     div.classList.add('new-rating');

    //     // Force reflow for smooth animation
    //     div.offsetHeight;

    //     // Remove highlight after 2s
    //     setTimeout(() => div.classList.remove('new-rating'), 10000);

    //     // Scroll the new rating into view
    //     div.scrollIntoView({ behavior: 'smooth', block: 'start' });
    //   }


    //   // Include business name + email inside comment area
    //   // const displayComment = `<span style="font-size:3px; font-weight:bold;">${r.business} â€” ${r.email}</span><br>${r.comment || '<em>No comment</em>'}`;

    //   const displayComment = `
    //     <span style="font-size:3px; font-weight:bold;">
    //       ${r.business} â€” ${r.email}
    //     </span><br>
    //     ${r.comment || '<em>No comment</em>'}
    //   `;



    //   div.innerHTML = `
    //     <div class="stars-display">${'â˜…'.repeat(r.rating)}${'â˜†'.repeat(5 - r.rating)}</div>
    //     <div>${r.comment || '<em>No comment</em>'}</div>
    //     <div class="timestamp">${new Date(r.timestamp).toLocaleString()}</div>
    //   `;

    //   ratingsList.appendChild(div);
    // });

    // Reset flag so only the last rating is highlighted
    lastSubmittedRating = null;

  } catch (err) {
    ratingsList.innerHTML = '<p>Error loading ratings.</p>';
    console.error(err);
  }
}



/* ======= Submit Rating ======= */

form.addEventListener('submit', async e => {
  e.preventDefault();
  
//   if (!currentUser) return alert('Please log in first');
  if (!currentUser) {
    alert('Please log in first');
    return;
  }

  if (!currentUser?.email || !currentUser?.phone) {
    alert("Your profile is incomplete. Please re-register.");
    return;
  }

  const comment = commentInput.value.trim();





  if (!currentBusiness) {
    alert('Please select a business');
    return;
  }
  if (!selectedRating) {
    alert('Please select a rating');
    return;
  }

  // Track what was just submitted
  // lastSubmittedRating = { rating: selectedRating, comment };

  
  try {
  
    const timestamp = new Date().toISOString();  // <-- add this line before the fetch
    
    lastSubmittedRating = { rating: selectedRating, comment, timestamp };
    





    console.log("Submitting rating with user:", {
      username: currentUser.username,
      email: currentUser.email,
      phone: currentUser.phone
    });







    await fetch('/api/ratings', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        business: currentBusiness,
        rating: selectedRating,
        comment,
        username: currentUser.username,
        email: currentUser.email,
        phone: currentUser.phone,
        timestamp
      })
    });

    // Reset form and selections
    commentInput.value = '';
    selectedRating = 0;
    emojiBtns.forEach(b => b.classList.remove('selected'));
    stars.forEach(s => s.classList.remove('selected'));

    // Fetch ratings and highlight new one
    fetchRatings();

  } catch (err) {
    console.error('Error submitting rating:', err);
    alert('Failed to submit rating.');
  }
});

/* ======= Init ======= */
renderBusinessCards();
selectBusiness(currentBusiness);

let currentUser = null;

async function fetchUser(firstTimeName = null) {
  let url = "/api/users";
  if (!currentUser && firstTimeName) {
    url += `?username=${encodeURIComponent(firstTimeName)}`;
  }

  const res = await fetch(url);

  // const user = await res.json();
  // // currentUser = user.username;
  // currentUser = user;
  // return user;

  const user = await res.json();

  // Only set currentUser if we don't already have full details
  if (!currentUser || !currentUser.email) {
    currentUser = user;
  }

  return user;



}


async function init() {
  try {
    // Try to fetch user from cookie / KV
    let user = await fetchUser(); 

    // If user doesn't exist, prompt once
    if (!user.username) {
      const username = prompt("Enter your username:");
      const email = prompt("Enter your email:");
      const phone = prompt("Enter your phone number:");

      // First-time creation call
      user = await fetchUserCreation({ username, email, phone });
    }

    currentUser = user; // full user object
    console.log("Logged in as:", currentUser.username);

  } catch (err) {
    console.error("Login/init error:", err);
  }
}

// Helper to create a new user in KV
async function fetchUserCreation({ username, email, phone }) {
  const res = await fetch(`/api/users?username=${encodeURIComponent(username)}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username, email, phone })
  });
  return await res.json();
}





// async function reRegister() {
//   // Clear local currentUser
//   currentUser = null;

//   // Delete cookie
//   document.cookie = "rateme_user=; Path=/; Max-Age=0";

//   // Reload app to trigger prompts
//   window.location.reload();
// }
// reRegister();










// Call init on page load
init();


document.getElementById('reRegisterBtn').addEventListener('click', async () => {
  // Clear cookie + in-memory user
  currentUser = null;
  document.cookie = "rateme_user=; Path=/; Max-Age=0";

  // Prompt for new user info
  const username = prompt("Enter username:");
  const email = prompt("Enter email:");
  const phone = prompt("Enter phone:");

  // POST to KV
  const res = await fetch('/api/users', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username, email, phone })
  });

  currentUser = await res.json();
  console.log("Re-registered as:", currentUser);

  // Immediately refresh ratings with updated user info
  fetchRatings();
});


// document.getElementById('reRegisterBtn').addEventListener('click', async () => {
//   // Clear cookie + state
//   currentUser = null;
//   document.cookie = "rateme_user=; Path=/; Max-Age=0";

//   // Force registration
//   const username = prompt("Enter username:");
//   const email = prompt("Enter email:");
//   const phone = prompt("Enter phone:");

//   const res = await fetch('/api/users', {
//     method: 'POST',
//     headers: { 'Content-Type': 'application/json' },
//     body: JSON.stringify({ username, email, phone })
//   });

//   currentUser = await res.json();
//   // console.log("Re-registered as:", currentUser.username);
//   console.log("Re-registered as:", currentUser);

// });



// document.getElementById('reRegisterBtn').addEventListener('click', async () => {
//   // Clear currentUser and cookie
//   currentUser = null;
//   document.cookie = "rateme_user=; Path=/; Max-Age=0";

//   // Call init() to trigger first-time registration prompts
//   await init();
// });








// async function init() {
//   try {
//     let user = await fetchUser(); // tries cookie first
//     if (!user.username) {
//       const name = prompt("Enter your username:"); // first-time
//       user = await fetchUser(name);
//     }
//     console.log("Logged in as:", user.username);
//   } catch (err) {
//     console.error("Login error:", err);
//   }
// }

// init();








</script>
  
<!-- Load JS at the end so DOM elements exist -->
<!-- <scri pt src="ind ex.js"></scr ipt> -->

</body>
</html>
